# =====================
# Dockerfile.dev
# =====================
FROM golang:1.25-alpine

# Install base tools and create user
RUN apk add --no-cache bash git ca-certificates build-base curl && \
    adduser -D -u 1000 vscode

# Set environment
ENV PATH="/usr/local/go/bin:/home/vscode/go/bin:${PATH}"
ENV GOPATH=/home/vscode/go
ENV GOMODCACHE=/home/vscode/go/pkg/mod
ENV GOFLAGS="-mod=mod -modcacherw"
ENV CGO_ENABLED=0

# Switch to work directory
WORKDIR /work

# Copy go.mod and go.sum first, then download deps
COPY go.mod go.sum ./
RUN go mod download

# Now copy the rest of the project
COPY . .

# Preinstall tools (optional)
RUN GOBIN=/usr/local/bin go install github.com/air-verse/air@latest && \
    GOBIN=/usr/local/bin go install github.com/go-delve/delve/cmd/dlv@latest && \
    GOBIN=/usr/local/bin go install golang.org/x/tools/gopls@latest && \
    GOBIN=/usr/local/bin go install honnef.co/go/tools/cmd/staticcheck@latest && \
    chown -R vscode:vscode /home/vscode/go

USER vscode
